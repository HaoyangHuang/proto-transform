syntax = "proto3";
package com.kodypay.grpc.auth.v1;

import "com/kodypay/grpc/shared/v1/device.proto";
import "google/protobuf/timestamp.proto";
import "options/team.proto";

option java_multiple_files = true;
option java_outer_classname = "NotifyProto";
option java_package = "com.kodypay.grpc.auth.v1";

service NotifyService {
  option (options.team) = BACKEND;

  rpc RegisterDevice(RegisterDeviceRequest) returns (RegisterDeviceResponse);
  rpc RemovePushDevice(RemovePushDeviceRequest) returns (RemovePushDeviceResponse);
  rpc GetPushDevices(GetPushDevicesRequest) returns (GetPushDevicesResponse);
  rpc SendPushNotification(SendPushNotificationRequest) returns (SendPushNotificationResponse);
  rpc GetPushNotifications(GetPushNotificationsRequest) returns (GetPushNotificationsResponse);
  rpc ConfirmPushNotification(ConfirmPushNotificationRequest) returns (ConfirmPushNotificationResponse);
  rpc DeletePushNotification(DeletePushNotificationRequest) returns (DeletePushNotificationResponse);
}

// use KU/Mobile auth header to identify user
message RegisterDeviceRequest {
  string push_id = 1; // Firebase push token
  string device_name = 2; // user friendly name for device
}
message RegisterDeviceResponse {
  com.kodypay.grpc.shared.v1.PushDevice device = 1;
}
message SendPushNotificationRequest {
  optional string notification_request_id = 6; // uuid either generated by sender or by service to identify this notification
  string title = 1; // title content to send in push notification
  string message = 2; // text content to send in push notification
  string send_from_user_id = 3; // who sent the notification
  repeated PushNotificationTarget send_to = 5; // where to send the notification
  optional string action = 4; // action to identify this push request type (enum)
  optional string actionData = 7; // optional json object, encoded into base64 when included in notification message
  optional google.protobuf.Timestamp expires_at = 8; // optional expiry for push notification

  message PushNotificationTarget {
    oneof id {
      string internal_device_id = 1; // devices that will receive the notification, send to specified device(s) only
      string target_user_id = 2; // users that will receive the notification, send to all devices of user(s)
    }
  }
}
message SendPushNotificationResponse {
  repeated PushNotification results = 1;
}

message GetPushNotificationsRequest {
  oneof id {
    string sent_to_internal_device_id = 1; // identify the device that should have received the notification
    string sent_to_user_id = 2; // identify the user who should have received the notification
  }
  optional google.protobuf.Timestamp sent_after = 3; // optionally filter by sending timestamp
  optional string action = 4; // optionally filter by request type
  optional string notification_request_id = 5; // optional filter by notification request UUID
  optional bool only_unconfirmed = 6; // optional filter to only include 'confirmed=false'
}
message GetPushNotificationsResponse {
  repeated PushNotification notifications = 1;
}
message PushNotification {
  string sent_notification_id = 1; // generated notification UUID
  string notification_request_id = 7; // uuid to identify the notification request, shared by all devices that received the notification
  string to_internal_device_id = 2;
  string to_user_id = 3;
  string from_user_id = 8;
  bool sent = 4;
  google.protobuf.Timestamp sent_at = 5;
  optional string action = 6; // action to identify this push request type (enum)
  optional string actionData = 9; // optional json object
  optional google.protobuf.Timestamp expires_at = 10;
  bool confirmed = 11;
}

message GetPushDevicesRequest {
    string user_id = 1; //user_id is always required for auth purpose unless using JWT
    optional string internal_device_id = 2;
}
message GetPushDevicesResponse {
  repeated com.kodypay.grpc.shared.v1.PushDevice devices = 1;
}

message RemovePushDeviceRequest {
  string user_id = 1;
  optional string internal_device_id = 2; // when not set removes all user's devices
}
message RemovePushDeviceResponse {
  repeated com.kodypay.grpc.shared.v1.PushDevice devices = 1; // remaining push devices after removal
}

message ConfirmPushNotificationRequest {
  string sent_notification_id = 1; // generated notification UUID
  string notification_request_id = 2; // uuid to identify the notification request, shared by all devices that received the notification
}
message ConfirmPushNotificationResponse {
  PushNotification notification = 1;
}

message DeletePushNotificationRequest {
  string sent_notification_id = 1; // generated notification UUID
  string notification_request_id = 2; // uuid to identify the notification request, shared by all devices that received the notification
}
message DeletePushNotificationResponse {
}
